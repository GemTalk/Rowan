# set -e # don't exit on error ... I want the record script to run at the end ....

. defStone.env

theVers=`awk 'NR==2{print $1; exit}' product/version.txt`

if [ "$theVers" = "3.6.1" ] || [ "$theVers" = "3.6.2" ] ; then
	# 3.6.0, 3.6.1, and 3.6.2 share same scripts
	vers=3.6.0
else
	vers=$theVers
fi

rm -rf *.log *.out

newExtent -s product/../hidden/bin/extent0.rowan.dbf $GEMSTONE_NAME

$ROWAN_PROJECTS_HOME/Rowan/platforms/gemstone/gsdevkit/superdoit/rowanAttachGitRepos.stone -D --gemstoneBaseImage --tests -- $GEMSTONE_NAME

$ROWAN_PROJECTS_HOME/Rowan/platforms/gemstone/gsdevkit/superdoit/runRowanTestSuiteV2.stone -D -- $GEMSTONE_NAME

#	./rowanTestStats.stone -h -- rowan_test_stats_361
#
branch=`git --git-dir=$ROWAN_PROJECTS_HOME/Rowan/.git rev-parse --abbrev-ref HEAD`

branchQuery=`./rowanTestStats.stone lookup --branch=$branch --gsVer=$vers -- rowan_test_stats_361 2>&1`
if [[ "$branchQuery" == "No sample found matching gsVer"* ]] ; then
	# this is a branch for which we have no samples with which to compare
	originalBranch=$branch
  branch=masterV3.0
	echo
	echo "USING DEFAULT BRANCH -- $branch -- instead of $originalBranch"
	echo
fi
./rowanTestStats.stone compare --jsonFile=testResults.json --gsVer=$vers --branch=$branch -- rowan_test_stats_361

