#!/usr/bin/env bash

set -e
. defStone.env

vers=`awk 'NR==2{print $1; exit}' product/version.txt`

rm -rf *.log *.out


startTopaz $GEMSTONE_NAME -l << EOF

	iferr 1 stk
	iferr 2 stack
	iferr 3 exit 1

	input $ROWAN_PROJECTS_HOME/Rowan/platforms/gemstone/topaz/3.2.15/install.tpz
	input $ROWAN_PROJECTS_HOME/Rowan/platforms/gemstone/topaz/rowanTestSuiteRowan.tpz
	exit
EOF

#	Report
# ./record.gs.st rowan_test_stats_350 -- --query=summary
#	Save the testResults.json in the db
# ./record.gs.st rowan_test_stats_350 -- --load=testResults.json --branch=issue_308
# ./record.gs.st rowan_test_stats_350 -- --load=testResults.json --branch=issue_308
#	Update the record with the SHA of the commit
# ./record.gs.st rowan_test_stats_350 -- --updateSHA=92de7b5  --branch=issue_308 --gsVersion=3.2.15
# ./record.gs.st rowan_test_stats_350 -- --updateSHA=92de7b5  --branch=issue_308 --gsVersion=3.5.0

branch=`git --git-dir=$ROWAN_PROJECTS_HOME/Rowan/.git rev-parse --abbrev-ref HEAD`

branchQuery=`./record.gs.st rowan_test_stats_350 -- --query --branch=$branch --gsVersion=$vers`

if [ "$branchQuery" = "[ ]" ] ; then
	# this is a branch for which we have no samples with which to compare 
  branch=candidateV1.2.11
	echo
	echo "USING DEFAULT BRANCH -- $branch"
	echo
fi
./record.gs.st rowan_test_stats_350 -- --load=testResults.json --branch=$branch --compare=$vers
